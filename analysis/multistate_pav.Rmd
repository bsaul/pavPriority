---
title: "Playing around with multistate models"
author: "Bradley Saul"
date: `r Sys.Date()`
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(msm)
library(pavPriority)
```


# Multistate models

TODO: Describe this.

## Assumptions

* no recovery (leaf can't become uninfected by a pathogen)

The following are the allowed transitions for each model. Zeros indicate a transition from state $i$ to $j$ is not permitted (except for diagonals -- leaves remain in the same state). The non-zero values don't matter.

```{r, echo = TRUE}
pC_dt   <- prepare_analysis_data(pav_dt, c("C", "pC", "R")) 
pCpR_dt <- prepare_analysis_data(pav_dt, c("C", "pC", "R", "pR")) 
```

```{r}
qconstr <- c(1, 2, 3, 4, 5, 6, 7 ,8, 2, 10, 10, 12, -2, 1, 1, 
             16, 5, 18, 5, 8, -2, 22, 22, 12, 25, 26,
             25, 28, 29, 30, -26, 32, 32, 28, -29, 30)
```

```{r, eval = FALSE}
write.csv(cbind(pC_dt$qdata, newq = qconstr), file = "inst/qupdate.csv")
```
A model with no covariates:

```{r, echo = TRUE}
fit <- fit_msm(
  formula     = stateL ~ leaf_age,
  subject     = pC_dt$data$LeafID,
  data        = pC_dt$data,
  startQ      = pC_dt$qmatrix,
  qconstraint = qconstr,
  control     = list(fnscale = 15000, maxit = 10000, trace = 1, reltol = 1e-8))

pmatrix.msm(fit)
```


```{r, echo = TRUE, eval = FALSE}
fit <- fit_msm(
  formula  = stateL ~ leaf_age,
  subject  = pC_dt$data$LeafID,
  data     = pC_dt$data,
  startQ   = pC_dt$qmatrix,
  qconstraint = qconstr,
  covariates = ~PAV,
  control  = list(fnscale = 15000, trace = 1, maxit = 1000))
```


```{r, echo = FALSE}
grab_transitions <- function(.msm, .from, .to, .covariates){
  .msm %>%
    compare_probs(
      t = 0:35, from = .from, to = .to,
      state_labels = states$state,
      .covariates = .covariates)
}
covs <- list(list(PAV = 0),  list(PAV = 1))
covs <- NULL
output <- bind_rows(
  grab_transitions(fit, 2, 4, covs),
  grab_transitions(fit, 2, 6, covs),
  grab_transitions(fit, 3, 4, covs),
  grab_transitions(fit, 3, 7, covs),
  grab_transitions(fit, 5, 7, covs),
  grab_transitions(fit, 5, 6, covs))
```


```{r}
vlines <- data_frame(
  x  = c(0, 0, 0, 1),
  metric = c("p1", "p2", "rd", "rr")
)

output %>% 
  tidyr::gather(key = "metric", value = "value", -comparison, -t, -PAV) %>%
  ggplot(
    data = .,
    aes(x = t, y = value, color = factor(PAV))
  ) + 
  geom_hline(data = vlines, aes(yintercept = x), color = "gray50") + 
  geom_line() + 
  scale_color_manual("PAV", values = c("#fc8d59", "#91bfdb")) + 
  facet_grid(metric ~ comparison, scales = "free_y") +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    axis.line.x      = element_blank(),
    axis.line.y      = element_line(color = "gray50"),
    axis.title.y     = element_blank() 
  )
```

```{r}
pnext0 <- pnext.msm(simple_msm, covariates = list(PAV = 0), ci = "delta")
pnext1 <- pnext.msm(simple_msm, covariates = list(PAV = 1), ci = "delta")

grab_pnext <- function(.msm, .covariates, from, to, state_labels){
    to_label   <- state_labels[to]
    from_label <- state_labels[from]
    msm_pnext  <- pnext.msm(.msm, covariates = .covariates, ci = "delta")
    data.frame(as.list(msm_pnext[from, to]))%>%
      mutate(   
        transition = sprintf("Pr[(%s) --> (%s)]", from_label, to_label),
      ) %>%
      {if(.covariates[1] != "mean") cbind(., as.data.frame(.covariates)) else . }

}

trans <- list(
  c(2, 4), c(2, 6), c(3, 4), c(3, 7), c(5, 7), c(5, 6)
)

pnexts <- bind_rows(
  purrr::map_dfr(trans, .f = ~ grab_pnext(simple_msm, list(PAV = 0), .x[1], .x[2], states$state)),
  purrr::map_dfr(trans, .f = ~ grab_pnext(simple_msm, list(PAV = 1), .x[1], .x[2], states$state))
)
```

```{r}
ggplot(pnexts,
       aes(x = factor(PAV), y = estimate, color = factor(PAV))) + 
  geom_point() + 
  geom_segment(aes(xend = factor(PAV), y = lower, yend = upper)) + 
  scale_color_manual("PAV", values = c("#fc8d59", "#91bfdb")) + 
  facet_grid(~transition)
```

